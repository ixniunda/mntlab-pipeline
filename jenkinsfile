node('EPBYMINW2470') {
    def mvnHome = tool 'gradle3.3'
    try{
    stage('Preparation') {
        checkout([$class: 'GitSCM', branches: [[name: 'kkaliada']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/MNT-Lab/mntlab-pipeline.git']]])
    }}
    catch (Exception err){
        sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"Preparation step was failed"}' https://hooks.slack.com/services/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"""

    }
    try {
    stage('Build') {
        sh "'${mvnHome}/bin/gradle' build"
    }}
    catch (Exception err){
        sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"Build step was failed"}' https://hooks.slack.com/services/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"""
    }
    try{
    stage('Test')
            {
                parallel (
                        "Cucumber Test":
                                {
                                    sh "'${mvnHome}/bin/gradle' cucumber"

                                },
                        "JUnit Test" :
                                {

                                    sh "'${mvnHome}/bin/gradle' test"

                                },
                        "Jacoco Test" :
                                {
                                    sh "'${mvnHome}/bin/gradle' jacocoTestReport"
                                })
            }}
    catch (Exception err){
        sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"Test step was failed"}' https://hooks.slack.com/services/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"""
    }
    try{
    stage('Triggering job and fetching artefact after finishing') {
        build job: 'MNTLAB-kkaliada-child1-build-job', parameters: [string( name: 'BRANCH_NAME', value: 'kkaliada')]
        copyArtifacts(projectName: 'MNTLAB-kkaliada-child1-build-job', filter: 'kkaliada_dsl_script.tar.gz')
    }}
    catch (Exception err){
        sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"Triggering job and fetching artefact after finishing step was failed"}' https://hooks.slack.com/services/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"""
    }
    try{
    stage('Packaging and Publishing results')
            {
                sh"tar -xvf kkaliada_dsl_script.tar.gz"
                sh"tar -cvzf pipeline-kkaliada-'$BUILD_NUMBER'.tar.gz dsl_jobs.groovy jenkinsfile build/libs/gradle-simple.jar"
		sh"curl -v -u admin:admin123 --upload-file pipeline-kkaliada-'$BUILD_NUMBER'.tar.gz http://10.0.0.14:8081/repository/LabTestRl/org/pipeline-kkaliada/'$BUILD_NUMBER'/pipeline-kkaliada-'$BUILD_NUMBER'.tar.gz
            }}
    catch (Exception err){
        sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"Packaging and Publishing results step was failed"}' https://hooks.slack.com/services/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"""

    }
    try{
    stage('Asking for manual approval'){
        input "Deploy to prod?"}}
        catch (Exception err){
            sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"approval step was failed"}' https://hooks.slack.com/services/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"""

        }
    try{
    stage('Deployment'){
        sh "java -jar build/libs/gradle-simple.jar"
    }}
    catch (Exception err){
        sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"Packaging and Publishing results step was failed"}' https://hooks.slack.com/services/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"""

    }

    stage('Sending status'){
         sh"""curl -X POST -H 'Content-type: application/json' --data '{"text":"Deploy to prod was successful completed "}' https://hooks.slack.com/services/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"""
    }

}


def brname = "ilahutka"
def giturl = "https://github.com/MNT-Lab/mntlab-pipeline.git"
def job = "_pipeline"
def tjob = "MNTLAB-ilahutka-child1-build-job"

node {
   
def grdlHome = tool "gradle3.3"
def jdkHome = tool "java8" 
   
   stage('Preparation - Checking out') { 
      checkout([$class: 'GitSCM', branches: [[name: "*/${brname}"]], userRemoteConfigs: [[url: "${giturl}"]]])
   }
   stage('Building code') { 
      sh "${grdlHome}/bin/gradle clean build"
   } 
    stage('Testing code') {
       parallel (
       cucumber: { sh "${grdlHome}/bin/gradle cucumber" },
       jacoco: { sh "${grdlHome}/bin/gradle jacocoTestReport" },
       test: { sh "${grdlHome}/bin/gradle test" }
       )
    }
    stage('Triggering job, fetching artefact') {
       build job: "${tjob}", parameters: [string(name: 'BRANCH_NAME', value: "${brname}")], propagate: true, wait: true
       sh "cp -f ${JENKINS_HOME}/workspace/${tjob}/${brname}_dsl_script.tar.gz ${JENKINS_HOME}/workspace/${job}/${brname}_dsl_script.tar.gz"
    }   
    stage('Packaging, publishing results') {
       sh "tar xzvf ${brname}_dsl_script.tar.gz jobs.groovy; cp build/libs/gradle-simple.jar gradle-simple.jar; tar czvf pipeline-${brname}-${BUILD_NUMBER}.tar.gz jobs.groovy jenkinsfile gradle-simple.jar"
       sh "curl -v -u jenkins:jenkins --upload-file pipeline-${brname}-${BUILD_NUMBER}.tar.gz http://172.28.128.27:8081/repository/project-releases/Releases/pipeline/${BUILD_NUMBER}/pipeline-${brname}-${BUILD_NUMBER}.tar.gz"
       archiveArtifacts artifacts: "pipeline-${brname}-${BUILD_NUMBER}.tar.gz", onlyIfSuccessful: true
    }
    stage('Asking for manual approval') {
       input message: 'Deploy the artifact?', ok: 'Yes'
    }
    stage('Deployment') {
       sh "${jdkHome}/bin/java -jar gradle-simple.jar"
    }
    
}

node  {
  def grdlHome
  grdlHome = tool 'gradle3.3'
  def jvHome
  jvHome = tool 'java8'

stage('Checkout') {
checkout([$class: 'GitSCM', branches: [[name: '*/alubouski']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/MNT-Lab/mntlab-pipeline.git']]])
}

 stage('Build') {
      // Run the gradle build
      grdlHome = tool 'gradle3.3'
      sh "'${grdlHome}/bin/gradle' build"
   }

 stage('Testing code') {
     parallel (
         cucumber: {sh "'${grdlHome}/bin/gradle' cucumber"},
           
            Unit_test : {sh "'${grdlHome}/bin/gradle' test"},
            
         jacocoTestReport : {sh "'${grdlHome}/bin/gradle' jacocoTestReport"}
         
            )
 }

stage('Triggering job'){
 build job: 'MNTLAB-alubouski-child1-build-job', parameters: [string(name: 'BRANCH_NAME', value: 'alubouski')]
 copyArtifacts(projectName: 'MNTLAB-alubouski-child1-build-job', filter: '*dsl_script.tar.gz');
 }


stage('Packaging and Publishing results'){
  sh "cd $JENKINS_HOME/workspace/$JOB_NAME/"      
  sh "tar -zxvf alubouski_dsl_script.tar.gz" 
  sh "cp build/libs/gradle-simple.jar ."
  sh "tar -zcvf pipeline-alubouski-'$BUILD_NUMBER'.tar.gz dsl.groovy jenkinsfile gradle-simple.jar"
  sh "curl -v --user 'admin:admin123' --upload-file pipeline-alubouski-'$BUILD_NUMBER'.tar.gz http://10.6.204.112:8081/repository/Artifact-storage/pipeline-alubouski-'$BUILD_NUMBER'.tar.gz"     
  archiveArtifacts artifacts: 'pipeline-alubouski-${BUILD_NUMBER}.tar.gz'
     }

 stage('Asking for manual approval'){
input message: 'You REALLY want to build?', ok: 'Yes'
 }   

try {
        // do something that doesn't fail
      stage('Deployment'){
 sh "'${jvHome}/bin/java' -jar gradle-simple.jar"
 }       
        currentBuild.result = 'SUCCESS'
   sh  ''' curl -X POST --data-urlencode "payload={\"channel\": \"#jenkins-kadiara\", \"username\": \"Java-app\", \"text\": \"Build was successful.\", \"icon_emoji\": \":tiger2:\"}" https://hooks.slack.com/services/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 '''

    } catch (Exception err) {
        currentBuild.result = 'FAILURE'
    sh ''' curl -X POST --data-urlencode "payload={\"channel\": \"#jenkins-kadiara\", \"username\": \"Java-app\", \"text\": \"Disaster please fix ASAP!.\", \"icon_emoji\": \":chicken:\"}" https://hooks.slack.com/services/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 '''
    }
    echo "RESULT: ${currentBuild.result}i"    

}
